FROM osgeo/gdal:ubuntu-full-3.0.3

ARG DEBIAN_FRONTEND=noninteractive

ARG nrn_working_dir=

ENV nrn_working_dir ${nrn_working_dir}

USER root

COPY . /nrn-app

WORKDIR /

RUN apt-get update

RUN apt-get install -y wget \
    build-essential \
    zlib1g-dev \
    libncurses5-dev \
    libgdbm-dev \
    libnss3-dev \
    libpq-dev \
    libssl-dev \
    libreadline-dev \
    libffi-dev \
    gnupg2 \
    binutils \
    postgresql \
    postgresql-contrib \
    postgis \
    python-psycopg2

RUN wget https://www.python.org/ftp/python/3.6.3/Python-3.6.3.tgz

RUN tar -xf Python-3.6.3.tgz

WORKDIR /Python-3.6.3

RUN ./configure && make -j 8 && make altinstall

RUN apt-get install -y python3-pip

WORKDIR /nrn-app

RUN pip3 install -r requirements.txt

USER postgres

RUN service postgresql start && psql --command "ALTER ROLE postgres WITH PASSWORD 'password';"

USER root

RUN update-rc.d postgresql enable
